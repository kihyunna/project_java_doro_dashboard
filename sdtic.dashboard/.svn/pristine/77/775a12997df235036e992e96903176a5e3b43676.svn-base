<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="ifcUnit">

    <typeAlias  alias="egovMap"   type="egovframework.rte.psl.dataaccess.util.EgovMap"  />
    <typeAlias  alias="ifcUnitVO"  type="egovframework.com.sdtic.ifcrs.service.IfcUnitVO" />

    <select id="ifcUnitDAO.ifcUnitAjax" parameterClass="ifcUnitVO" resultClass="ifcUnitVO">
        /* ifcUnitAjax 조회 */
        SELECT A.UNIT,
               A.UNIT_NAME,
               A.UNIT_ORDER,
               A.GUBUN,
               A.GUBUN_NAME,
               A.GUBUN_ORDER,
               A.HOSTNAME,
               A.SERVER_GUBUN,
               A.DUAL,
               B.DISK,
               B.CPU,
               B.MEM MEMORY,
               CASE WHEN SERVER_GUBUN = 'CON'
                    THEN (SELECT DECODE (EVT_CODE, 'WAS_PROCESS_IS_DOWN', 'N', 'Y')
		                    FROM (SELECT CFG_PATH, STAT_DATE, EVT_CODE
		                            FROM SYSMSTCC.SMB_TX_EVT_LOG_S) AA,
		                         (SELECT CFG_PATH, MAX (STAT_DATE) MAX_STAT_DATE
		                            FROM SYSMSTCC.SMB_TX_EVT_LOG_S
		                           GROUP BY CFG_PATH) BB
		                   WHERE AA.CFG_PATH = BB.CFG_PATH
		                     AND AA.STAT_DATE = BB.MAX_STAT_DATE
		                     AND AA.CFG_PATH = A.HOSTNAME)
                    ELSE ''
               END CON_YN
          FROM IOC_SDTIC_IFC_UNIT A,
               (SELECT CC.HOSTNAME,
                       MAX(AA.INST_DATE) INST_DATE,
                       MAX(AA.DISK) DISK,
                       MAX(AA.CPU) CPU,
                       MAX(AA.MEM) MEM
                  FROM (SELECT REAL_HOSTNAME,
                               INST_DATE,
                               DISK,
                               CPU,
                               MEM
                          FROM IOC_SDTIC_IFC_COLCT_DATA) AA,
                       (  SELECT REAL_HOSTNAME,
                                 MAX (INST_DATE) MAX_INST_DATE
                            FROM IOC_SDTIC_IFC_COLCT_DATA
                        GROUP BY (REAL_HOSTNAME)) BB,
                        IOC_SDTIC_IFC_HOSTNAME_COLCT CC
                 WHERE AA.REAL_HOSTNAME = BB.REAL_HOSTNAME
                   AND AA.INST_DATE = BB.MAX_INST_DATE
                   AND AA.REAL_HOSTNAME = CC.REAL_HOSTNAME
                 GROUP BY CC.HOSTNAME
               ) B  
         WHERE A.HOSTNAME = B.HOSTNAME(+)
           AND A.UNIT = #unit#
         ORDER BY UNIT_ORDER, GUBUN_ORDER, SERVER_GUBUN, HOSTNAME
    </select>

	<select id="ifcUnitDAO.ifcUnitGrid1Ajax" parameterClass="ifcUnitVO" resultClass="ifcUnitVO">
        /* ifcUnitGrid1Ajax 조회 */
        SELECT A.UNIT,
		       MAX(A.UNIT_NAME) UNIT_NAME,
		       MAX(A.UNIT_ORDER) UNIT_ORDER
		  FROM IOC_SDTIC_IFC_UNIT A
		 GROUP BY A.UNIT
		 ORDER BY UNIT_ORDER
    </select>
    
    <select id="ifcUnitDAO.ifcUnitGrid2Ajax" parameterClass="ifcUnitVO" resultClass="ifcUnitVO">
        /* ifcUnitGrid2Ajax 조회 */
        SELECT A.GUBUN,
		       MAX(A.GUBUN_NAME) GUBUN_NAME,
		       MAX(A.GUBUN_ORDER) GUBUN_ORDER
		  FROM IOC_SDTIC_IFC_UNIT A
       <![CDATA[
         WHERE A.UNIT = #unit#
       ]]>
		 GROUP BY A.GUBUN
		 ORDER BY GUBUN_ORDER
    </select>
     
    <select id="ifcUnitDAO.ifcUnitGrid2DetailAjax" parameterClass="ifcUnitVO" resultClass="ifcUnitVO">
        /* ifcUnitGrid2DetailAjax 조회 */
        SELECT A.UNIT,
		       MAX(A.UNIT_NAME) UNIT_NAME,
		       MAX(A.UNIT_ORDER) UNIT_ORDER,
		       A.GUBUN,
		       MAX(A.GUBUN_NAME) GUBUN_NAME,
		       MAX(A.GUBUN_ORDER) GUBUN_ORDER
		  FROM IOC_SDTIC_IFC_UNIT A
		  <![CDATA[
		  WHERE A.UNIT = #unit#
		   AND A.GUBUN = #gubun#
		  ]]>
		  GROUP BY A.UNIT, A.GUBUN
    </select>
    
    <update id="ifcUnitDAO.ifcUnitModGrid2Ajax" parameterClass="ifcUnitVO">
    	<![CDATA[
        /* ifcUnitModGrid2Ajax 수정 */
        UPDATE IOC_SDTIC_IFC_UNIT SET
             GUBUN     		= #gubun#
            ,GUBUN_NAME   	= #gubun_name#
            ,GUBUN_ORDER	= #gubun_order#
        WHERE UNIT = #unit#
          AND GUBUN = #ori_gubun#
        ]]>
    </update>
    
    <delete id="ifcUnitDAO.ifcUnitDelGrid2Ajax" parameterClass="ifcUnitVO" >
		<![CDATA[
		/* ifcUnitDelGrid2Ajax 삭제 */
		DELETE FROM IOC_SDTIC_IFC_UNIT
	   	 WHERE UNIT = #unit#
           AND GUBUN = #ori_gubun#	
		]]>	
	</delete>
    
    <select id="ifcUnitDAO.ifcUnitGrid3Ajax" parameterClass="ifcUnitVO" resultClass="ifcUnitVO">
        /* ifcUnitGrid3Ajax 조회 */
        SELECT A.SERVER_GUBUN,
        	   A.HOSTNAME
		  FROM IOC_SDTIC_IFC_UNIT A
       <![CDATA[
         WHERE A.UNIT = #unit#
           AND A.GUBUN = #gubun#
       ]]>
		 ORDER BY SERVER_GUBUN, HOSTNAME
    </select>
    
    <insert id="ifcUnitDAO.ifcUnitAddGrid3Ajax" parameterClass="ifcUnitVO">
      	<![CDATA[
        /* ifcUnitAddGrid3Ajax 입력 */
        INSERT INTO IOC_SDTIC_IFC_UNIT
        (
             UNIT
            ,GUBUN
            ,HOSTNAME
            ,DUAL
            ,SERVER_GUBUN
            ,UNIT_ORDER
            ,GUBUN_ORDER
            ,UNIT_NAME
            ,GUBUN_NAME
        )
        VALUES
        (
             #unit#
            ,#gubun#
            ,#hostname#
            ,#dual#
            ,#server_gubun#
            ,#unit_order#
            ,#gubun_order#
            ,#unit_name#
            ,#gubun_name#
        )
       ]]>
     </insert>
     
     <select id="ifcUnitDAO.ifcUnitGrid3DetailAjax" parameterClass="ifcUnitVO" resultClass="ifcUnitVO">
        /* ifcUnitGrid3DetailAjax 조회 */
        SELECT A.UNIT,
		       A.UNIT_NAME,
		       A.UNIT_ORDER,
		       A.GUBUN,
		       A.GUBUN_NAME,
		       A.GUBUN_ORDER,
		       A.HOSTNAME,
		       A.SERVER_GUBUN,
		       A.DUAL
		  FROM IOC_SDTIC_IFC_UNIT A
		 <![CDATA[
		 WHERE A.UNIT = #unit#
		   AND A.GUBUN = #gubun#
		 ]]>
		 <isNotEmpty property="server_gubun">
             <![CDATA[
             AND A.SERVER_GUBUN = #server_gubun#
             ]]>
         </isNotEmpty>
         <isEmpty property="server_gubun">
             <![CDATA[
             AND A.SERVER_GUBUN is null
             ]]>
         </isEmpty>
         <![CDATA[
		   AND A.HOSTNAME = #hostname#
		 ]]>
    </select>
    
    <update id="ifcUnitDAO.ifcUnitModGrid3Ajax" parameterClass="ifcUnitVO">
    	<![CDATA[
        /* ifcUnitModGrid3Ajax 수정 */
        UPDATE IOC_SDTIC_IFC_UNIT SET
             HOSTNAME     	= #hostname#
            ,SERVER_GUBUN   = #server_gubun#
            ,DUAL  			= #dual#
        WHERE UNIT = #unit#
          AND GUBUN = #gubun#
          AND HOSTNAME = #ori_hostname#
        ]]>
	    <isNotEmpty property="server_gubun">
            <![CDATA[
            AND SERVER_GUBUN = #ori_server_gubun#
            ]]>
        </isNotEmpty>
        <isEmpty property="server_gubun">
            <![CDATA[
            AND SERVER_GUBUN is null
            ]]>
        </isEmpty>
    </update>
    
    <delete id="ifcUnitDAO.ifcUnitDelGrid3Ajax" parameterClass="ifcUnitVO" >
		<![CDATA[
		/* ifcUnitDelGrid3Ajax 삭제 */
		DELETE FROM IOC_SDTIC_IFC_UNIT
	   	 WHERE UNIT = #unit#
           AND GUBUN = #gubun#
           AND HOSTNAME = #ori_hostname#
        ]]>
        <isNotEmpty property="server_gubun">
            <![CDATA[
            AND SERVER_GUBUN = #ori_server_gubun#
            ]]>
        </isNotEmpty>
        <isEmpty property="server_gubun">
            <![CDATA[
            AND SERVER_GUBUN is null
            ]]>
        </isEmpty>
	</delete>
	
	<select id="ifcUnitDAO.ifcUnitTroblAjax" parameterClass="ifcUnitVO" resultClass="ifcUnitVO">
        /* ifcUnitTroblAjax 조회 */
		/* DISK */
		  SELECT TT.UNIT
		    FROM (SELECT UT.UNIT,
		                 UT.HOSTNAME,
		                 UT.DISK,
		                 UT.DUAL_DISK,
		                 UT.THRHLD
		            FROM (SELECT A.UNIT,
		                         A.HOSTNAME,
		                         A.DUAL,
		                         B.DISK,
		                         C.DISK DUAL_DISK,
		                         (SELECT THRHLD
		                            FROM IOC_SDTIC_EVENT_COLCT_CYCLE
		                           WHERE DETAILCLSE = 'DISK' AND TROBLGRADSE = '1')
		                            THRHLD
		                    FROM IOC_SDTIC_IFC_UNIT A,
		                         (  SELECT CC.HOSTNAME,
		                                   MAX (AA.INST_DATE) INST_DATE,
		                                   MAX (AA.DISK) DISK
		                              FROM (SELECT REAL_HOSTNAME, INST_DATE, DISK
		                                      FROM IOC_SDTIC_IFC_COLCT_DATA) AA,
		                                   (  SELECT REAL_HOSTNAME,
		                                             MAX (INST_DATE) MAX_INST_DATE
		                                        FROM IOC_SDTIC_IFC_COLCT_DATA
		                                    GROUP BY (REAL_HOSTNAME)) BB,
		                                   IOC_SDTIC_IFC_HOSTNAME_COLCT CC
		                             WHERE     AA.REAL_HOSTNAME = BB.REAL_HOSTNAME
		                                   AND AA.INST_DATE = BB.MAX_INST_DATE
		                                   AND AA.REAL_HOSTNAME = CC.REAL_HOSTNAME
		                          GROUP BY CC.HOSTNAME) B,
		                         (  SELECT CC.HOSTNAME,
		                                   MAX (AA.INST_DATE) INST_DATE,
		                                   MAX (AA.DISK) DISK
		                              FROM (SELECT REAL_HOSTNAME, INST_DATE, DISK
		                                      FROM IOC_SDTIC_IFC_COLCT_DATA) AA,
		                                   (  SELECT REAL_HOSTNAME,
		                                             MAX (INST_DATE) MAX_INST_DATE
		                                        FROM IOC_SDTIC_IFC_COLCT_DATA
		                                    GROUP BY (REAL_HOSTNAME)) BB,
		                                   IOC_SDTIC_IFC_HOSTNAME_COLCT CC
		                             WHERE     AA.REAL_HOSTNAME = BB.REAL_HOSTNAME
		                                   AND AA.INST_DATE = BB.MAX_INST_DATE
		                                   AND AA.REAL_HOSTNAME = CC.REAL_HOSTNAME
		                          GROUP BY CC.HOSTNAME) C
		                   WHERE A.HOSTNAME = B.HOSTNAME AND A.DUAL = C.HOSTNAME) UT
		           WHERE UT.DISK >= UT.THRHLD AND UT.DUAL_DISK >= UT.THRHLD) TT
		GROUP BY TT.UNIT
		
		UNION
		
		/* CON_YN */
		  SELECT UT.UNIT
		    FROM (SELECT A.UNIT,
		                 A.HOSTNAME,
		                 A.DUAL,
		                 CASE
		                    WHEN A.SERVER_GUBUN = 'CON'
		                    THEN
		                       (SELECT DECODE (EVT_CODE,
		                                       'WAS_PROCESS_IS_DOWN', 'N',
		                                       'Y')
		                          FROM (SELECT CFG_PATH, STAT_DATE, EVT_CODE
		                                  FROM SYSMSTCC.SMB_TX_EVT_LOG_S) AA,
		                               (  SELECT CFG_PATH, MAX (STAT_DATE) MAX_STAT_DATE
		                                    FROM SYSMSTCC.SMB_TX_EVT_LOG_S
		                                GROUP BY CFG_PATH) BB
		                         WHERE     AA.CFG_PATH = BB.CFG_PATH
		                               AND AA.STAT_DATE = BB.MAX_STAT_DATE
		                               AND AA.CFG_PATH = A.HOSTNAME)
		                    ELSE
		                       ''
		                 END
		                    CON_YN,
		                 CASE
		                    WHEN A.SERVER_GUBUN = 'CON'
		                    THEN
		                       (SELECT DECODE (EVT_CODE,
		                                       'WAS_PROCESS_IS_DOWN', 'N',
		                                       'Y')
		                          FROM (SELECT CFG_PATH, STAT_DATE, EVT_CODE
		                                  FROM SYSMSTCC.SMB_TX_EVT_LOG_S) AA,
		                               (  SELECT CFG_PATH, MAX (STAT_DATE) MAX_STAT_DATE
		                                    FROM SYSMSTCC.SMB_TX_EVT_LOG_S
		                                GROUP BY CFG_PATH) BB
		                         WHERE     AA.CFG_PATH = BB.CFG_PATH
		                               AND AA.STAT_DATE = BB.MAX_STAT_DATE
		                               AND AA.CFG_PATH = A.DUAL)
		                    ELSE
		                       ''
		                 END
		                    DUAL_CON_YN
		            FROM IOC_SDTIC_IFC_UNIT A) UT
		   WHERE UT.CON_YN = 'N' AND UT.DUAL_CON_YN = 'N'
		GROUP BY UNIT
    </select>
    
</sqlMap>