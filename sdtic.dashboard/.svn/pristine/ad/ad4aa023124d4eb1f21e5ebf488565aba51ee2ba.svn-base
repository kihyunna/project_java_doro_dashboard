<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c"       uri="http://java.sun.com/jsp/jstl/core"                     %>

<!DOCTYPE html>
<html lang="ko">
<head>
<title></title>
    <meta charset="utf-8">
    <title>비즈니스 시설물 누적접속자 화면</title>
    <!-- including ECharts file -->
    <c:set var="contextPath" value="${pageContext.request.contextPath}" />
    <script type="text/javascript" src="${contextPath}/js/common/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="${contextPath}/js/bucrs/anime.js"></script>

    <link rel="stylesheet" type="text/css" href="${contextPath}/css/main/magicTime.css">
    <link rel="stylesheet" type="text/css" href="${contextPath}/css/main/default.css" />
</head>

<body>
    <div id="wrap_if">
        <div id="pln_main" class="sctSmrSys tpFclt">
            <div class="areaSys"><!--시설물--></div>
            <div class="areaIndC">
                <span class="txtItem">시설물가동률 </span><br /><span id="data1" class="txtNum"> %</span>
            </div>
            <div class="areaCUsr">
                <span class="txtItem">금일누적접속자</span><br /><span id="JSobjectProp" class="txtNum"> 명</span>
            </div>
        </div>
    </div>
    

        <script type="text/javascript">
        var ParamTime = 0;
            $(window).load(function() {
            	document.documentElement.style.overflow = 'hidden';
            getFcltsAccmltConectr();
            
            
            ParamTime = "${param.widgetTimer}"
                
                if(ParamTime == 0){
                	ParamTime = 10000;
                }
            
          //이벤트
            if(window.addEventListener) {
                window.addEventListener("message", uf_receiveMessage, false);
            }else if(window.attachEvent) {  //IE에서 이벤트 등록
                window.attachEvent("onmessage", uf_receiveMessage);
            }
            
            timerStart();
                
            });

            $(window).resize(function(){

                //setDivHeight('main');

            });

            function setDivHeight(objSet)
            {


                var objSet   = document.getElementById(objSet);
                objSet.style.width  = 100 + "%";
                objSet.style.height  = $(window).height() + "px";

            }

            function getFcltsAccmltConectr(){
                $.ajax({
                    url : "${pageContext.request.contextPath}/buc/bucFcltsAccmltConectrAjax.do",
                    async : false,
                    dataType : 'json',
                    success :function(json) {
						if(json.data.length > 0)
                        	$('#JSobjectProp').text(json.data[0].connector + " 명");
						else 
							$('#JSobjectProp').text(0 + " 명");
                    },error : function(){

                        console.log(arguments);
                    }, complete : function() {
                    	
                        var tempText = $('#JSobjectProp').text().replace(' 명','');
                        
                        var prop1 = parseInt(tempText);
                    	
                        var myObject = { prop1: 0 };
                        var JSobjectProp = anime({
                            targets: myObject,
                            prop1: prop1,
                            easing: 'linear',
                            delay: 650,
                            round: 1,
                            update: function() {
                                var el = document.querySelector('#JSobjectProp');

                                var jsonString = JSON.stringify(myObject).replace('{"prop1":','').replace('"}','').replace('"','');

                                el.innerHTML = jsonString+ ' 명';
                            }
                        });
                    }
                });

                $.ajax({
                    url : "${pageContext.request.contextPath}/buc/bucFcltsRtAjax.do",
                    async : false,
                    dataType : 'json',
                    success :function(json) {
                    	if(json.data.length > 0)
                        	$('#data1').text(json.data[0].rate + " %");
                    	else
                    		$('#data1').text(0 + " %");

                    },error : function(){

                        console.log(arguments);
                    }, complete : function() {
                    	var tempText = $('#data1').text().replace(' %','');
                        
                        var prop2 = parseInt(tempText);
                        var myObject2 = { prop2: 0 };
                        var JSobjectProp = anime({
                            targets: myObject2,
                            prop2: prop2,
                            easing: 'linear',
                            delay: 650,
                            round: 1,
                            update: function() {
                                var el = document.querySelector('#data1');

                                var jsonString = JSON.stringify(myObject2).replace('{"prop2":','').replace('"}','').replace('"','');

                                el.innerHTML = jsonString + ' %';
                            }
                        });
                    }
                });

            }

            function randomCnt(){
            	getFcltsAccmltConectr();

            }

            function timerStart(){
            	setInterval(function() {
                    randomCnt();
                }, ParamTime);
            }

           

          //성능 위젯으로 서버통신
            function fn_tranServer(data){
                var callCommandVariable = {
                    classType: "1",
                    command : "bucFclts",
                    data : {
                        bucData : data
                    }
                };
                setTimeout(function(){
                    parent.postMessage(callCommandVariable, "*");
                }, 1000);
            }
            
            function uf_receiveMessage(e){
                var command = e.data.command;
                switch(command){
                    case 'ReturnbucFclts' : {
                        
                        //alert(1);
                        
                            $("#pln_main").removeClass("sctSmrSys tpPln active");
                            $("#pln_main").addClass('sctSmrSys tpPln');
                        
                        
                        fn_tranServer("0");
                        break;
                    }
                    
                    default : {
                        
                        if(parseInt(e.data.data.bucData)== 3){
                            $("#pln_main").addClass('sctSmrSys tpPln active');
                        }
                        
                        break;
                    } 
                }
            }

        </script>
</body>
</html>
