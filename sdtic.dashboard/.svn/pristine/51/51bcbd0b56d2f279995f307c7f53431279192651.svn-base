<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>

<!DOCTYPE html>
<html lang="ko" class="cnt_if">
	<head>
		<meta charset="utf-8" />
		<title>도로기술/시설</title>
		
	    <!-- including ECharts file -->
	    <c:set var="contextPath" value="${pageContext.request.contextPath}" />
	
	    <script type="text/javascript" src="${contextPath}/js/common/jquery-2.1.4.min.js"></script>
	    <script type="text/javascript" src="${contextPath}/js/echarts/dist/echarts.min.js"></script>
	
	    <script type="text/javascript" src="${contextPath}/js/echarts/theme/dark.js"></script>
	    <script type="text/javascript" src="${contextPath}/js/ifcrs/IfcDbUnityView.js"></script>
	
	    <link rel="stylesheet" type="text/css" href="${contextPath}/css/main/csshake.css">
	    <link rel="stylesheet" type="text/css" href="${contextPath}/css/main/magicTime.css">
	    
	    <script type="text/javascript">
            $(window).load(function(){
            	getData();
            	timeTicketRunFnc();
            	
            	setDivHeight('main');
            	setBorderDivHeight('mainBorder');
            });
            
            //리사이즈
            $(window).resize(function(){
                setDivHeight('main');
                setBorderDivHeight('mainBorder');
            });
            
            function setDivHeight(objSet){ 
                var objSet   = document.getElementById(objSet); 
                objSet.style.width  = ($(window).width()) + "px";
                objSet.style.height  = ($(window).height()) + "px";
                
                $(objSet).width(($(window).width()) + "px");
                $(objSet).height(($(window).height()) + "px");
                
                myChart.resize({
                    width: $(window).width(),
                    height : $(window).height()
                });
            } 
            
            function setBorderDivHeight(objSet){ 
            	var objSet   = document.getElementById(objSet); 
                objSet.style.width  = ($(window).width() - 10) + "px";
                objSet.style.height  = ($(window).height() - 10) + "px";
                
                $(objSet).width(($(window).width() - 10) + "px");
                $(objSet).height(($(window).height() - 10) + "px");
            }
        </script>
	</head>
	
	<!-- 백그라운드 이미지 넣으면 차트도 동일하게 적용됩니다. -->
	<body>
	    <div id="main" style="width:500px;height:255px;"></div>
	    <div id="mainBorder" style="position:absolute;top:0px;left:0px;width:490px;height:255px;border:solid 5px #f00;display:none;"></div>
	    
	    <script type="text/javascript">
	        var myChart = echarts.init(document.getElementById('main'), 'dark');
	        myChart.setOption(option);
	        
	        var cpuData = 0;
	        var memoryData = 0;
	        var diskData = 0;
	        
	        var chkStyle = /\d/;
	        var widgetTimer = 60000 * 10;	//10분
	        var paramWidgetTimer = "${param.widgetTimer}";
	        if(paramWidgetTimer != null){
	        	if(chkStyle.test(paramWidgetTimer)){
	        		if(paramWidgetTimer != 0){
	        			widgetTimer = paramWidgetTimer;
	        		}
	        	}
	        }
	        
	        function getData(){      	
	        	$.ajax({
	                url : "${pageContext.request.contextPath}/ifc/ifcDbUnity.do",
	                async : false,
	                dataType : 'json',
	                data:{
	                    'gubun'    : 'DB'
	                   ,'group1'   : 'DB'
	                   ,'group2'   : 'CFM'
	                },
	                success :function(json) {
	                	cpuData = 0;
	                    memoryData = 0;
	                    diskData = 0;
	                    
	                  	//DISK
                        if(json.data[0] != null && json.data[0].disk != null){
                        	diskData = json.data[0].disk;
                        }
                        option.series[0].data[0].value = diskData;
	                    
	                    //CPU
	                    if(json.data[0] != null && json.data[0].cpu != null){
	                    	cpuData = json.data[0].cpu;
	                    }
	                    option.series[1].data[0].value = cpuData;
	                    
	                    //MEMORY
	                    if(json.data[0] != null && json.data[0].memory != null){
	                    	memoryData = json.data[0].memory;
                        }
                        option.series[2].data[0].value = memoryData;
	                    
	                    myChart.setOption(option);	                    
	                },error : function(){
	                    console.log(arguments);
	                }
	            });

            	myChart.setOption(option);  
	        }
	
	        var timeTicketRun;
	        var timeTicketStop;
	
	        function timeTicketStopFnc(){
	            clearInterval(timeTicketRun);
	            $("#mainBorder").show();
	
	            timeTicketStop = setTimeout(function (){
	            	$("#mainBorder").hide();
	                
	              	//데이터 가져오기
	                getData();
	              
	                timeTicketRunFnc();
	            }, widgetTimer);
	        }
	
	        function timeTicketRunFnc(){
	        	if(option.series[0].data[0].value >= 90){
                    timeTicketStopFnc();
	        	}else{
		            timeTicketRun = setInterval(function (){
		            	//데이터 가져오기
		            	getData();
		
		                if(option.series[0].data[0].value >= 90){
		                    timeTicketStopFnc();
		                }
		            }, widgetTimer);
	        	}
	        }
	    </script>
	</body>
</html>